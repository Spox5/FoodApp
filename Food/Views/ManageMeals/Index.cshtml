@model Food.ViewModel.SearchMealViewModel


@{ Layout = "~/Views/Shared/_Layout.cshtml"; }


<div class="main">

    <div class="title">Twoje posiłki:</div>


        @foreach (var meal in Model.Meals)
        {
        <label class="btn btn-outline-primary">
            <input class="meal-input" value="@meal.Id" name="meal" type="radio"> @meal.Name
        </label>
        }
                
        <div class="meal-name-form">
            <input class="meal-name-input form-control" placeholder="Nowa nazwa posiłku">
            <textarea class="meal-recipe-input form-control w-50 mx-auto m-2" placeholder="Nowy przepis"></textarea>
            <input class="save-button btn btn-outline-primary m-2" type="button" value="Zapisz">
        </div>

        <div>
            <input class="edit-button btn btn-outline-warning m-2" type="button" value="Edytuj">
            <input class="delete-button btn btn-outline-danger m-2" type="button" value="Usuń">
        </div>
        

        <div class="ingredients border-dark border-top m-4 pt-4">

            <div class="title">Stwórz nowy posiłek</div>

            <div><input class="input-field form-control w-25 mx-auto m-2" placeholder="Nazwa nowego posiłku"></div>

            <div class="ingredients-fruits m-3">
                <div style="font-weight: bold">Owoce</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 1)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }

            </div>

            <div class="ingredients-vegetables m-3">
                <div style="font-weight: bold">Warzywa</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 2)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-meat m-3">
                <div style="font-weight: bold">Mięso</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 3)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-fish m-3">
                <div style="font-weight: bold">Ryby</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 4)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-pasta m-3">
                <div style="font-weight: bold">Kasze i makarony</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 5)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-spieces m-3">
                <div style="font-weight: bold">Przyprawy</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 6)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-dairy m-3">
                <div style="font-weight: bold">Nabiał</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 7)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-bread m-3">
                <div style="font-weight: bold">Pieczywo</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 9)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            <div class="ingredients-other m-3">
                <div style="font-weight: bold">Inne</div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    @if (ingredient.TypeId == 10)
                    {
                        <label class="btn btn-outline-primary">
                            @ingredient.Name <input value="@ingredient.Id" type="checkbox">
                        </label>
                    }
                }
            </div>

            @*<div>
                @foreach (var ingredient in Model.Ingredients)
                {
                    <label class="btn btn-outline-primary ingredients">
                        <input class="ingredients-checkboxes" value="@ingredient.Id" type="checkbox" /> @ingredient.Name
                    </label>
                }
            </div>*@
            <textarea class="input-meal-recipe-field form-control w-50 mx-auto m-2" rows="5" placeholder="Przepis na nowy posiłek"></textarea>

            <button class="add-button btn btn-outline-success" type="button">Dodaj</button>

        </div>

</div>


<script>

    const ingredientsContainer = document.querySelector('.ingredients')
    const addButton = document.querySelector('.add-button')
    const addMealName = document.querySelector('.input-field')
    const addMealRecipe = document.querySelector('.input-meal-recipe-field')
    const editButton = document.querySelector('.edit-button')
    const deleteButton = document.querySelector('.delete-button')
    const editInput = document.querySelector('.meal-name-input')
    const editInputRecipe = document.querySelector('.meal-recipe-input')
    const editForm = document.querySelector('.meal-name-form')
    const saveButton = document.querySelector('.save-button')

    editForm.style.display = 'none'
    bindEvents();


    function bindEvents() {
        addButton.onclick = addMeal
        editButton.onclick = displayOrHideEditForm
        saveButton.onclick = updateMeal
        deleteButton.onclick = deleteMeal
    }

    function addMeal() {
        const ingredients = Array.from(ingredientsContainer.querySelectorAll('.ingredients-checkboxes'));
        const selectedIngredients = ingredients
            .filter(ingredient => ingredient.checked)
            .map(ingredient => parseInt(ingredient.value))
        const meal = {
            name: addMealName.value,
            userId: parseInt(window.localStorage.getItem("userId")),
            recipe: addMealRecipe.value,
            mealIngredients: selectedIngredients.map(ingredient => ({ ingredientId: ingredient }))
        }

        fetch("/ManageMeals/Add", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(meal)
        })

        setTimeout(function () {
            window.location.reload();
        }, 500); 

    }


    function updateMeal() {

        const selectedMeal = Array.from(document.querySelectorAll('.meal-input')).find(meal => meal.checked)

        const meal = {
            Id: parseInt(selectedMeal.value),
            Name: editInput.value,
            Recipe: editInputRecipe.value,
            //userId: parseInt(window.sessionStorage.getItem("userId")),
            userId: 1
        }

        fetch("/ManageMeals/Update", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(meal)
        })

        setTimeout(function () {
            window.location.reload();
        }, 500); 

    }


    function deleteMeal() {
        const selectedMeal = Array.from(document.querySelectorAll('.meal-input')).find(meal => meal.checked)


        const meal = {
            id: parseInt(selectedMeal.value),
            name: 'fds',
            userId: 1
        }


        fetch("/ManageMeals/Delete", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(meal)
        })

        setTimeout(function () {
            window.location.reload();
        }, 500); 
    }

    function displayOrHideEditForm() {
        if (editForm.style.display == 'none') {
            editForm.style.display = 'block'
        }
        else if (editForm.style.display == 'block') {
            editForm.style.display = 'none'
        }
    }


</script>


    